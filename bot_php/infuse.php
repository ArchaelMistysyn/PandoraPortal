<?php

$infusion_recipes = [
    "Heavenly Infusion" => [
        "Heavenly Ore (Crude)" => [["Ore1", 50], ["Stone1", 5], 75, "Ore5", null],
        "Heavenly Ore (Cosmite)" => [["Ore2", 20], ["Stone2", 5], 75, "Ore5", null],
        "Heavenly Ore (Celestite)" => [["Ore3", 10], ["Stone3", 5], 75, "Ore5", null],
        "Heavenly Ore (Crystallite)" => [["Ore4", 2], ["Stone4", 5], 75, "Ore5", null]
    ],
    "Elemental Infusion" => [
        "Ruby" => [["Catalyst", 1], ["Fae0", 300], 80, "Gemstone0", null],
        "Sapphire" => [["Catalyst", 1], ["Fae1", 300], 80, "Gemstone1", null],
        "Topaz" => [["Catalyst", 1], ["Fae2", 300], 80, "Gemstone2", null],
        "Agate" => [["Catalyst", 1], ["Fae3", 300], 80, "Gemstone3", null],
        "Emerald" => [["Catalyst", 1], ["Fae4", 300], 80, "Gemstone4", null],
        "Zircon" => [["Catalyst", 1], ["Fae5", 300], 80, "Gemstone5", null],
        "Obsidian" => [["Catalyst", 1], ["Fae6", 300], 80, "Gemstone6", null],
        "Opal" => [["Catalyst", 1], ["Fae7", 300], 80, "Gemstone7", null],
        "Amethyst" => [["Catalyst", 1], ["Fae8", 300], 80, "Gemstone8", null]
    ],
    "Crystal Infusion" => [
        "Crystallized Void (Fragment)" => [["Fragment1", 20], 100, "Crystal1", null],
        "Crystallized Wish (Fragment)" => [["Fragment2", 20], 100, "Crystal2", null],
        "Crystallized Abyss (Fragment)" => [["Fragment3", 20], 100, "Crystal3", null],
        "Crystallized Divinity (Fragment)" => [["Fragment4", 20], 100, "Crystal4", null],
        "Crystallized Wish (Upgrade)" => [["Crystal1", 3], 90, "Crystal2", null],
        "Crystallized Abyss (Upgrade)" => [["Crystal2", 3], 90, "Crystal3", null],
        "Crystallized Divinity (Upgrade)" => [["Crystal3", 3], 90, "Crystal4", null]
    ],
    "Void Infusion" => [
        "Unrefined Void Item (Weapon)" => [["Crystal1", 1], ["Scrap", 200], 99, "Void1", null],
        "Unrefined Void Item (Armour)" => [["Crystal1", 1], ["Scrap", 100], 99, "Void2", null],
        "Unrefined Void Item (Greaves)" => [["Crystal1", 1], ["Unrefined2", 10], 99, "Void3", null],
        "Unrefined Void Item (Amulet)" => [["Crystal1", 1], ["Scrap", 100], 99, "Void4", null],
        "Unrefined Void Item (Wing)" => [["Crystal1", 1], ["Unrefined1", 10], 99, "Void5", null],
        "Unrefined Void Item (Crest)" => [["Crystal1", 1], ["Unrefined3", 10], 99, "Void6", null]
    ],
    "Jewel Infusion" => [
        "Unrefined Dragon Jewel" => [["Gem1", 10], 75, "Jewel1", null],
        "Unrefined Demon Jewel" => [["Gem2", 10], 75, "Jewel2", null],
        "Unrefined Paragon Jewel" => [["Gem3", 10], 75, "Jewel3", null]
    ],
    "Skull Infusion" => [
        "Haunted Golden Skull" => [["Skull1", 1], 100, "Skull2", null],
        "Radiant Golden Skull" => [["Skull2", 1], 100, "Skull3", null],
        "Prismatic Golden Skull" => [["Skull3", 1], 100, "Skull4", null]
    ],
    "Special Infusion" => [
        "Radiant Heart" => [["Stone6", 1], ["Fragment2", 1], 20, "Heart1", null],
        "Chaos Heart" => [["Stone6", 1], ["Fragment3", 1], 20, "Heart2", null],
        "Abyss Flame" => [["Crystal3", 1], ["Flame1", 10], 80, "Flame2", null],
        "Lotus of Serenity" => [["Heart1", 99], ["Fragment2", 99], 99, "Lotus3", null]
    ],
    "Elemental Signet" => [
        "Elemental Signet of Fire" => [["Gemstone0", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Water" => [["Gemstone1", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Lightning" => [["Gemstone2", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Earth" => [["Gemstone3", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Wind" => [["Gemstone4", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Ice" => [["Gemstone5", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Shadow" => [["Gemstone6", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Light" => [["Gemstone7", 2], ["Scrap", 100], 100, "4", "R"],
        "Elemental Signet of Celestial" => [["Gemstone8", 2], ["Scrap", 100], 100, "4", "R"]
    ],
    "Primordial Ring" => [
        "Ruby Ring of Incineration" => [["Gemstone0", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Sapphire Ring of Atlantis" => [["Gemstone1", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Topaz Ring of Dancing Thunder" => [["Gemstone2", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Agate Ring of Seismic Tremors" => [["Gemstone3", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Emerald Ring of Wailing Winds" => [["Gemstone4", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Zircon Ring of the Frozen Castle" => [["Gemstone5", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Obsidian Ring of Tormented Souls" => [["Gemstone6", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Opal Ring of Scintillation" => [["Gemstone7", 5], ["Gemstone10", 1], 100, "5", "R"],
        "Amethyst Ring of Shifting Stars" => [["Gemstone8", 5], ["Gemstone10", 1], 100, "5", "R"]
    ],
    "Path Ring" => [
        "Invoking Ring of Storms" => [["Gemstone1", 5], ["Gemstone2", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Primordial Ring of Frostfire" => [["Gemstone0", 5], ["Gemstone5", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Boundary Ring of Horizon" => [["Gemstone3", 5], ["Gemstone4", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Hidden Ring of Eclipse" => [["Gemstone6", 5], ["Gemstone7", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Cosmic Ring of Stars" => [["Gemstone8", 10], ["Gemstone10", 2], 100, "6", "R"],
        "Orbital Ring of Solar Flux" => [["Gemstone0", 5], ["Gemstone4", 5], ["Gemstone7", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Orbital Ring of Lunar Tides" => [["Gemstone1", 5], ["Gemstone5", 5], ["Gemstone6", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Orbital Ring of Terrestria" => [["Gemstone2", 5], ["Gemstone3", 5], ["Gemstone8", 5], ["Gemstone10", 2], 100, "6", "R"],
        "Rainbow Ring of Confluence" => [["Gemstone0", 2], ["Gemstone1", 2], ["Gemstone2", 2], ["Gemstone3", 2],
                                         ["Gemstone4", 2], ["Gemstone5", 2], ["Gemstone6", 2], ["Gemstone7", 2],
                                         ["Gemstone8", 2], ["Gemstone10", 2], 100, "6", "R"]
    ],
    "Fabled Ring" => [
        "Dragon's Eye Diamond" => [["Gemstone9", 15], ["Gemstone10", 3], 100, "7", "R"],
        "Bleeding Hearts" => [["Gemstone9", 5], ["Heart1", 50], ["Heart2", 50], ["Gemstone10", 3], 100, "7", "R"],
        "Gambler's Masterpiece" => [["Gemstone9", 1], ["Gemstone10", 1], 1, "7", "R"],
        "Lonely Ring of the Dark Star" => [["DarkStar", 1], ["Gemstone9", 5], ["Gemstone10", 3], 100, "7", "R"],
        "Lonely Ring of the Light Star" => [["LightStar", 1], ["Gemstone9", 5], ["Gemstone10", 3], 100, "7", "R"]
    ],
    "Sovereign Ring" => [
        "Stygian Calamity" => [["Shard", 25], ["Gemstone11", 1], ["Gemstone10", 5], ["Crystal3", 10], ["Crystal4", 1], 100, "8", "R"],
        "Heavenly Calamity" => [["Shard", 25], ["Gemstone11", 1], ["Ore5", 10], ["Gemstone10", 5], ["Crystal4", 1], 100, "8", "R"],
        "Hadal's Raindrop" => [["Shard", 25], ["Nadir", 1], ["EssenceXIV", 10], ["Gemstone10", 5], ["Crystal4", 1], 100, "8", "R"],
        "Twin Rings of Divergent Stars" => [["LightStar", 1], ["DarkStar", 1], ["Gemstone10", 5], ["Crystal4", 1], 100, "8", "R"],
        "Crown of Skulls" => [["Shard", 50], ["Skull4", 1], ["Lotus2", 1], ["Gemstone10", 5], ["Crystal4", 1], 100, "8", "R"],
        "Chromatic Tears" => [["Shard", 50], ["Lotus11", 1], ["Gemstone10", 10], ["Crystal4", 1], 100, "8", "R"]
    ],
    "Sovereign Gear" => [
        "Pandora's Universe Hammer" => [["Shard", 50], ["Lotus10", 1], ["Crystal4", 1], 100, "8", "W"],
        "Fallen Lotus of Nephilim" => [["Shard", 50], ["Nephilim", 1], ["Lotus10", 1], ["Crystal4", 1], 100, "8", "W"],
        "Solar Flare Blaster" => [["Shard", 25], ["Gemstone0", 10], ["Gemstone4", 10], ["Gemstone7", 10],
                                  ["Gemstone9", 10], ["EssenceXIX", 10], ["Crystal4", 1], 100, "8", "W"],
        "Bathyal, Enigmatic Chasm Bauble" => [["Shard", 25], ["Nadir", 1], ["Crystal4", 1], 100, "8", "W"],
        "Ruler's Crest" => [["Shard", 1000], ["Ruler", 1], ["Gemstone0", 100], ["Gemstone1", 100], ["Gemstone2", 100],
                            ["Gemstone3", 100], ["Gemstone4", 100], ["Gemstone5", 100], ["Gemstone6", 100],
                            ["Gemstone7", 100], ["Gemstone8", 100], ["Gemstone9", 100], ["Crystal4", 10], 100, "8", "C"]
    ]
];

$all_recipe_names = [];
foreach ($infusion_recipes as $recipes) {
    $all_recipe_names += array_fill_keys(array_keys($recipes), true);
}

class RecipeObject {
    public $category, $recipe_name, $recipe_info, $cost_items, $success_rate, $outcome_id, $item_type, $is_gear;

    public function __construct($category, $recipe_name, $recipe_info) {
        $this->category = $category;
        $this->recipe_name = $recipe_name;
        $this->recipe_info = $recipe_info;
        $len = count($recipe_info);
        $this->cost_items = array_slice($recipe_info, 0, $len - 3);
        $this->success_rate = $recipe_info[$len - 3] ?? 100;
        $this->outcome_id = $recipe_info[$len - 2] ?? null;
        $this->item_type = $recipe_info[$len - 1] ?? null;
        $this->is_gear = $this->item_type !== null;
    }
    public static function from_name($recipe_name) {
        global $infusion_recipes;
        foreach ($infusion_recipes as $category => $recipes) {
            if (isset($recipes[$recipe_name])) {
                return new RecipeObject($category, $recipe_name, $recipes[$recipe_name]);
            }
        }
        return null;
    }

    public function create_cost_html($player) {
        global $itemData;
        if ($this->is_gear) {
            $tier = intval($this->outcome_id);
            $custom = new CustomItem(0, $this->item_type, $tier, $this->recipe_name);
            $filepath = htmlspecialchars($custom->get_gear_thumbnail(), ENT_QUOTES, 'UTF-8');
            $item_name = $custom->item_name;
        } else {
            $item = new BasicItem($this->outcome_id);
            $filepath = get_frame_image($this->outcome_id);
            $item_name = $item->item_name;
        }

        $html = "<img src='{$filepath}' alt='{$item_name}' class='gear-icon'>";
        $html .= "<div class='style-line'></div>";
        $html .= "<div class='infuse-header highlight-text'>{$this->recipe_name}</div>";
        $html .= "<div class='cost-row'><span class='cost-name'>Creates: </span><span class='cost-quantity'>1x</span></div>";
        $html .= "<div class='cost-row'><span class='cost-name'>Success Rate: </span><span class='cost-quantity'>{$this->success_rate}%</span></div>";

        if (!$this->is_gear) {
            $item_stock = checkUserStock($player->player_id, [$this->outcome_id])[$this->outcome_id] ?? 0;
            $html .= "<div class='cost-row'><span class='cost-name'>Stock: </span><span class='cost-quantity'>{$item_stock}</span></div>";
        }

        $html .= "<div class='style-line'></div>";

        $can_craft = true;
        $stock_map = checkUserStock($player->player_id, array_column($this->cost_items, 0));
        $sacred_stock = checkUserStock($player->player_id, ['Sacred'])['Sacred'] ?? 0;

        foreach ($this->cost_items as [$item_id, $qty]) {
            $name = $itemData[$item_id]["name"];
            $img = htmlspecialchars($itemData[$item_id]["image_link"], ENT_QUOTES, 'UTF-8');
            $stock = $stock_map[$item_id] ?? 0;
            if ($stock < $qty) $can_craft = false;

            $html .= "<div class='cost-row'>
                        <img src='$img' alt='$name' class='cost-icon'>
                        <span class='cost-name'>$name</span>
                        <span class='cost-quantity'>$stock / $qty</span>
                    </div>";
        }

        return [$html, $can_craft, $this->is_gear, $sacred_stock > 0];
    }

    public function execute_infusion($player_profile, $is_sacred = false, $craft_qty = 0) {
        $cost_items = $this->cost_items;
        if ($is_sacred) {
            $cost_items[] = ["Sacred", 1];
        }
        $stock = checkUserStock($player_profile->player_id, array_column($cost_items, 0));
        foreach ($cost_items as [$item_id, $cost_qty]) {
            if (($stock[$item_id] ?? 0) < $cost_qty) {
                [$embed_html, $can_craft, , $has_sacred] = $this->create_cost_html($player_profile);
                return ["attempt_success" => false, "html" => "<div class='item-displaybox'>$embed_html</div>",
                    "menu" => $this->build_infusion_menu($can_craft, $has_sacred)
                ];
            }
        }
        pay_batch_cost($player_profile->player_id, $cost_items);
        $success = rand(1, 100) <= $this->success_rate;
        $html = '';
        if ($success) {
            if ($this->is_gear) {
                $item_tier = $is_sacred ? 9 : intval($this->outcome_id);
                $custom = new CustomItem($player_profile->player_id, $this->item_type, $item_tier, $this->recipe_name, $is_sacred);
                $custom->set_item_name();
                $custom->saveChanges('new');
                $html = generate_gear_content($player_profile, $custom)['html'];
            } else {
                update_stock($player_profile->player_id, $this->outcome_id, $craft_qty);
                $html = $this->create_cost_html($player_profile)[0];
            }
        }
        [$embed_html, $can_craft, , $has_sacred] = $this->create_cost_html($player_profile);
        return ["attempt_success" => $success, "html" => $success ? $html : "<div class='item-displaybox'>$embed_html</div>",
            "menu" => $this->build_infusion_menu($can_craft, $has_sacred)
        ];
    }

    public function build_infusion_menu($can_craft, $has_sacred) {
        $recipe = addslashes($this->recipe_name);
        $menu = $can_craft
            ? "<button class='lightbox-button-green' onclick=\"executeInfusion('{$recipe}')\">Craft</button>"
            : "<button class='lightbox-button-gray'><s>Craft</s></button>";

        if ($this->is_gear && intval($this->outcome_id) === 8) {
            if ($has_sacred && $can_craft) {
                $menu .= "<button class='lightbox-button-red' onclick=\"executeSacredInfusion('{$recipe}')\">Sacred</button>";
            }
        }

        $menu .= "<button class='lightbox-button-gray' onclick='closeLightbox()'><span class='symbol-height'>✖</span> Close</button>";
        return $menu;
    }

}

?>